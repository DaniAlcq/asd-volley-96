<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#121212"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <title>ASD VOLLEY 96</title>
  <link rel="stylesheet" href="css/style.css"/>

  <style>
    /* Loader */
    #app-loader{position:fixed;inset:0;z-index:100000;display:grid;place-items:center;background:#0b0b0b}
    #app-loader .spinner{width:48px;height:48px;border:4px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
    #app-loader.hidden{opacity:0;pointer-events:none;transition:opacity .3s ease}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Modal immagini */
    .modal-img-viewer{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);z-index:99999}
    .modal-img-viewer.open{display:flex}
    .modal-img-viewer img{max-width:90vw;max-height:90vh;object-fit:contain}
  </style>
</head>

<body>
  <header class="header-tot">
    <img class="brand-logo" src="img/bianco.png" alt="Logo">
    <button class="hamburger" id="hamburger" aria-label="Apri menu" type="button">&#9776;</button>

    <nav id="navbar">
      <a href="index.html" data-url="index.html">Home</a>
      <a href="squadre.html" data-url="squadre.html">Squadre</a>
      <a href="calendario.html" data-url="calendario.html">Calendario e Risultati</a>
      <a href="classifiche.html" data-url="classifiche.html">Classifiche</a>
      <a href="contatti.html" data-url="contatti.html">Contatti</a>
      <a id="nav-live" href="#" style="display:none">Diretta <span class="live-dot" aria-hidden="true"></span></a>
    </nav>

    <div class="social-icons">
      <a href="https://www.instagram.com/a.s.d.volley96/" target="_blank" rel="noopener noreferrer">
        <img class="social-logo-insta" src="img/instagram.png" alt="Instagram">
      </a>
      <a href="https://www.facebook.com/asdvolley96" target="_blank" rel="noopener noreferrer">
        <img class="social-logo-facebook" src="img/facebook.png" alt="Facebook">
      </a>
    </div>
  </header>

  <main>
    <div>
      <div class="news-wrapper">
        <section class="news-carousel">
          <button class="prev" type="button">❮</button>
          <div class="slides"></div>
          <button class="next" type="button">❯</button>
        </section>
      </div>

      <section class="news-grid"></section>
    </div>

    <a href="https://www.fimaformazione.it/" target="_blank" rel="noopener noreferrer">
      <div class="sponsor-banner">
        <img src="img/cropped-Fima-Logo-01.png" alt="Sponsor Logo" class="sponsor-logo">
      </div>
    </a>
    <a href="https://www.fimaformazione.it/" target="_blank" rel="noopener noreferrer">
      <div class="sponsor-banner">
        <img src="https://www.adgsrl.com/wp-content/uploads/2025/01/LOGO-ADG-NDT-SOLUTIONS-ROSSO.png" alt="Sponsor Logo" class="sponsor-logo">
      </div>
    </a>

    <section class="results-section">
      <h2 class="results-title">Ultimi Risultati</h2>
      <div class="buttons-filter">
        <button data-cat="Femminile" class="filter-btn active" type="button">Femminile</button>
        <button data-cat="Maschile" class="filter-btn" type="button">Maschile</button>
      </div>
      <div class="results-grid" id="results-container"></div>
    </section>

    <section class="mvp-section">
      <h2 class="mvp-title">Ultimi scarabei di giornata</h2>
      <div class="mvp-grid" id="scarabei-container"></div>
    </section>

    <section class="teams-section">
      <h2 class="teams-title">Le nostre squadre</h2>
      <div class="teams-grid">
        <a href="squadre.html?cat=Femminile" data-url="squadre.html?cat=Femminile">
          <div class="team-card">
            <img src="img/squadra_femminile/femminile.jpg" alt="Squadra 1">
            <h3>Serie C femminile</h3>
          </div>
        </a>
        <a href="squadre.html?cat=Maschile" data-url="squadre.html?cat=Maschile">
          <div class="team-card">
            <img src="img/squadra_maschile/maschile.jpg" alt="Squadra 2">
            <h3>Serie C maschile</h3>
          </div>
        </a>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <p>© <span id="year"></span> ASD VOLLEY 96 — Tutti i diritti riservati</p>
    <p>Web design &amp; sviluppo © 2025 <a href="mailto:danilo.alacqua@example.com">Danilo Alacqua</a></p>
  </footer>

  <!-- Modal unico -->
  <div class="modal-img-viewer" id="imgModal" aria-hidden="true" role="dialog">
    <img src="" alt="">
  </div>

  <!-- Loader -->
  <div id="app-loader" aria-live="polite" aria-busy="true">
    <div class="spinner" aria-hidden="true"></div>
  </div>

  <script src="js/fade.js" defer></script>
  <script src="js/live.js" defer></script>
  <script src="js/script.js" defer></script>
  <script src="js/menu.js" defer></script>

  <script>
    const SHEET_ID = "1ucM1JY5MXHF7-9mpjp2mfB41TvoA1ziMUGGz86woQXA";
    const GS = (tab) => `https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent(tab)}`;
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];
    const tidy = (s) => typeof s === 'string' ? s.trim() : s;
    const fixImg = (s) => tidy(s);
    const parseSets = (str) => (tidy(str || '') || '').split(',').map(x => x.trim()).filter(Boolean);

    async function fetchSheet(tab){
      const res = await fetch(GS(tab), { cache:'no-store' });
      if(!res.ok) throw new Error(`Fetch fallito: ${tab} (${res.status})`);
      return res.json();
    }

    function hideLoader() {
      const el = document.getElementById('app-loader');
      if (!el) return;
      el.classList.add('hidden');
      el.addEventListener('transitionend', () => el.remove(), { once:true });
      setTimeout(() => el && el.remove(), 1000);
    }

    function initYear(){
      const y = $('#year');
      if (y) y.textContent = new Date().getFullYear();
    }

    function initImageModal(){
      const modal = $('#imgModal');
      const imgEl = modal.querySelector('img');

      // click solo sulle immagini del carosello
      document.addEventListener('click', (e) => {
        const img = e.target.closest('.news-carousel img');
        if (!img) return;
        imgEl.src = img.currentSrc || img.src;
        modal.classList.add('open');
        modal.setAttribute('aria-hidden','false');
      });

      modal.addEventListener('click', () => {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden','true');
        imgEl.src = '';
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('open')) modal.click();
      });
    }

    async function initCarosello(){
      try{
        const rows = await fetchSheet('Carosello');
        const slides = rows.map(r => ({
          immagine: fixImg(r.immagine),
          caption: tidy(r.caption),
          descrizione: tidy(r.descrizione)
        }));

        const wrap = $('.news-carousel .slides');
        if(!wrap) return;

        wrap.innerHTML = '';
        for(const s of slides){
          const d = document.createElement('div');
          d.className = 'slide';
          d.innerHTML = `
            <div class="slide-left">
              <img src="${s.immagine}" alt="${s.caption || ''}">
            </div>
            <div class="slide-right">
              <h3>${s.caption || ''}</h3>
              <p>${s.descrizione || ''}</p>
            </div>`;
          wrap.appendChild(d);
        }

        const prev = $('.news-carousel .prev');
        const next = $('.news-carousel .next');
        const items = $$('.news-carousel .slide');
        if(!items.length || !prev || !next) return;

        let i = 0;
        const n = items.length;
        const upd = () => { wrap.style.transform = `translateX(${-i*100}%)`; };

        prev.addEventListener('click', () => { i = (i-1+n) % n; upd(); });
        next.addEventListener('click', () => { i = (i+1) % n; upd(); });

        document.addEventListener('keydown', (e) => {
          if(e.key === 'ArrowLeft') prev.click();
          if(e.key === 'ArrowRight') next.click();
        });

        upd();
      }catch(e){
        console.error('Carosello:', e);
      }
    }

    let newsData = [];
    async function initNews(){
      try{
        const rows = await fetchSheet('News');
        newsData = rows.map(r => ({
          id: tidy(r.id),
          titolo: tidy(r.titolo),
          immagine: fixImg(r.immagine),
          contenuto: tidy(r.contenuto)
        }));

        const grid = $('.news-grid');
        if(!grid) return;
        grid.innerHTML = '';

        for(const n of newsData){
          const f = document.createElement('figure');
          f.className = 'news-card';
          f.dataset.id = n.id;
          f.innerHTML = `
            <img src="${n.immagine}" alt="${n.titolo}">
            <figcaption>${n.titolo}</figcaption>`;
          grid.appendChild(f);
        }

        document.addEventListener('click', (e) => {
          const card = e.target.closest('.news-card');
          if(!card) return;
          e.preventDefault();
          showNews(card.dataset.id);
        });

        const hid = location.hash.slice(1);
        if(hid) showNews(hid, true);

        window.addEventListener('popstate', (e) => {
          if(e.state && e.state.id) showNews(e.state.id, true);
          else location.reload();
        });
      }catch(e){
        console.error('News:', e);
      }
    }

    function showNews(id, replace=false){
      const main = document.querySelector('main');
      if(!main) return;

      const n = newsData.find(x => String(x.id) === String(id));
      if(!n){
        main.innerHTML = '<p>News non trovata.</p>';
        return;
      }

      main.innerHTML = `
        <article class="news-detail">
          <h2>${n.titolo}</h2>
          <img src="${n.immagine}" alt="${n.titolo}">
          <p>${n.contenuto}</p>
          <button class="back-btn" type="button" onclick="history.back()">⬅ Torna indietro</button>
        </article>`;

      window.scrollTo({ top: 0 });

      if(replace) history.replaceState({ id }, '', `#${id}`);
      else history.pushState({ id }, '', `#${id}`);
    }

    async function initScarabei(){
      try{
        const rows = await fetchSheet('Scarabei');
        const c = $('#scarabei-container');
        if(!c) return;
        c.innerHTML = '';

        for(const p of rows){
          const d = document.createElement('div');
          d.className = 'mvp-card';
          d.innerHTML = `
            <img src="${fixImg(p.immagine)}" alt="${tidy(p.nome) || ''}">
            <h3>${tidy(p.nome) || ''}</h3>
            <p>${tidy(p.categoria) || ''}</p>
            ${p.prestazione ? `<p><strong>Prestazione 🏐</strong><br>${tidy(p.prestazione)}</p>` : ''}`;
          c.appendChild(d);
        }
      }catch(e){
        console.error('Scarabei:', e);
      }
    }

    async function initRisultati(){
      const btns = $$('.filter-btn');
      const box  = $('#results-container');

      const render = (cat, rows) => {
        if(!box) return;
        box.innerHTML = '';

        const f = rows
          .filter(m => (m.categoria || '').toLowerCase() === cat.toLowerCase())
          .slice(0, 3);

        for(const m of f){
          const d = document.createElement('div');
          d.className = 'result-card';
          d.innerHTML = `
            <h4 class="result-day">${tidy(m.giorno) || ''}</h4>
            <div class="logos">
              <div class="team">
                <img src="${fixImg(m.squadraCasa_logo)}" alt="${tidy(m.squadraCasa_nome) || ''}">
                <span>${tidy(m.squadraCasa_nome) || ''}</span>
              </div>
              <div class="resCasa">${tidy(m.risultatoCasa) ?? ''}</div>
              <div class="vs">-</div>
              <div class="resOsp">${tidy(m.risultatoOspite) ?? ''}</div>
              <div class="team">
                <img src="${fixImg(m.squadraOspite_logo)}" alt="${tidy(m.squadraOspite_nome) || ''}">
                <span>${tidy(m.squadraOspite_nome) || ''}</span>
              </div>
            </div>
            <ul class="result-sets">
              ${parseSets(m.sets).map(s => `<li>${s}</li>`).join('')}
            </ul>`;
          box.appendChild(d);
        }
      };

      try{
        const rows = await fetchSheet('Risultati');
        render('Femminile', rows);

        btns.forEach((b) => {
          b.addEventListener('click', () => {
            btns.forEach(x => x.classList.remove('active'));
            b.classList.add('active');
            render(b.dataset.cat, rows);
          });
        });
      }catch(e){
        console.error('Risultati:', e);
      }
    }

    function initMenuActive(){
      const links = $$('#navbar a');
      const cur = location.pathname.split('/').pop() || 'index.html';
      links.forEach(a => a.classList.toggle('active', a.getAttribute('href') === cur));
    }

    function boot(){
      initYear();
      initMenuActive();
      initImageModal();

      void initCarosello();
      void initNews();
      void initScarabei();
      void initRisultati();

      requestAnimationFrame(() => requestAnimationFrame(hideLoader));
      setTimeout(hideLoader, 3000);
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
